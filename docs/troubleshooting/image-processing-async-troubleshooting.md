# 이미지 처리 비동기화 트러블슈팅 정리

## 1. 문제 배경

Dearwith 서비스에서 리뷰, 이벤트 등에 다수의 이미지를 업로드할 수 있도록 구현되어 있는데

이미지 업로드 시 다음 작업들이 **동기 처리**로 수행되고 있었다.

- 원본 이미지 S3 업로드
- 이미지 리사이징 및 포맷 변환 (WebP)
- 여러 variant 생성 (1x / 2x / large 등)
- S3 업로드
- DB 상태 갱신

이로 인해 다음 문제가 발생했다.

### ❌ 문제점
- 고해상도 이미지(약 12MP) 업로드 시 요청 응답 시간이 **1.5~2초 이상** 지연
- 이미지 개수가 늘어날수록 응답 시간이 선형적으로 증가
- 리뷰 등록, 이벤트 생성 API의 UX 저하
- DB 트랜잭션 안에서 CPU / I/O 작업이 길게 유지됨

---

## 2. 기존 구조 (동기 처리)

```text
[HTTP 요청]
   ↓
[DB 트랜잭션 시작]
   ↓
[원본 업로드]
   ↓
[variant 생성 + 업로드]
   ↓
[DB 상태 업데이트]
   ↓
[응답 반환]
```

### **문제의 핵심**

- **variant 생성이 응답 경로에 포함**
- 트랜잭션 커밋이 늦어짐
- 사용자에게 결과가 보이기까지 시간이 길어짐

---

## 3. 해결 전략

### **UX 관점에서의 재해석**

하지만 사용자가 업로드 직후 **즉시 필요한 것은**

모든 variant가 아닌 **“원본 이미지가 정상적으로 보이는지”**였다.

- variant는 목록/상세 화면 렌더링을 위한 최적화 수단
- 업로드 직후 즉시 사용되지 않아도 UX에 큰 영향이 없음

→ **모든 처리를 동기로 묶을 필요가 없다는 결론에 도달**

### **핵심 아이디어**

> 오래 걸리는 이미지 가공 작업을 비동기로 분리하고,
> 사용자에게는 원본 이미지를 먼저 제공하자
- 사용자 UX에 직접 영향을 주는 부분만 동기 처리
- 비용·시간이 큰 작업은 백그라운드로 분리

### **적용 전략**

1. **원본 업로드 + DB 커밋은 동기 처리**
2. **variant 생성은 트랜잭션 커밋 이후 비동기 처리**
3. **처리 상태를 DB(ImageProcessStatus)로 관리**
    - PROCESSING / READY / FAILED
4. variant 생성 전까지는 **원본 이미지 기준 URL 제공**

---

## **4. 개선된 구조 (비동기 처리)**

```text
[HTTP 요청]
   ↓
[DB 트랜잭션 시작]
   ↓
[tmp → inline 원본 승격]
   ↓
[Image 상태: PROCESSING]
   ↓
[DB 커밋]
   ↓
[즉시 응답 반환]

(이후)
[비동기 executor]
   ↓
[variant 생성 + 업로드]
   ↓
[Image 상태: READY / FAILED]
```

---

## **5. ImageProcessStatus 도입**

이미지 처리 상태를 명확히 관리하기 위해 enum을 추가했다.
```text
public enum ImageProcessStatus {
    READY,        // 모든 variant 생성 완료
    PROCESSING,   // 비동기 처리 중
    FAILED        // 처리 실패
}
```
| **단계** | **status** | **processStatus** |
| --- | --- | --- |
| 임시 업로드 | TMP | READY |
| 원본 커밋 | COMMITTED | PROCESSING |
| variant 완료 | COMMITTED | READY |
| 오류 발생 | COMMITTED | FAILED |
→ 비동기 처리 중에도 서비스 흐름이 깨지지 않도록
이미지의 현재 사용 가능 여부를 명확히 판단하기 위한 상태 모델
---


## **6. 트랜잭션 롤백 & S3 문제 대응**

### **⚠️ 중요한 함정**

> DB 트랜잭션이 롤백되어도 S3 업로드는 롤백되지 않음
>

### **대응 방식**

- S3 업로드는 **DB 커밋 이후** 실행
- 비동기 작업은 트랜잭션 커밋 이후 실행되도록 afterCommit executor로 분리해
DB 롤백 시 S3 정합성 문제를 방지
- variant 생성 실패 시:
    - DB에 FAILED 상태 기록
    - 재처리 또는 관리자 점검 가능

→ DB 트랜잭션과 외부 스토리지의 경계를 명확히 분리했다.

---

## **7. 성능 개선 결과**

### **테스트 조건**

- 이미지: 약 12MP 고해상도 이미지
- 업로드 개수: 2장
- 동일 환경에서 비교

### **개선 전 (동기 처리)**

- variant 생성 포함
- 총 처리 시간: **약 1.6초**

### **개선 후 (비동기 처리)**

- HTTP 응답 기준
- 응답 시간: **약 400~800ms**
- variant 생성은 백그라운드에서 수행

➡️ **사용자 체감 응답 시간 약 50% 이상 감소**
